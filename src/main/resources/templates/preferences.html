<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Preferences - TPC Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #1e40af 100%); }
        .company-item { transition: all 0.3s ease; cursor: move; }
        .company-item:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .company-item.dragging { opacity: 0.5; transform: rotate(5deg); }
        .drag-over { background-color: #dbeafe; border: 2px dashed #3b82f6; }
        .priority-badge { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    </style>
</head>
<body class="bg-gray-50">
<nav class="bg-white shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">

            <!-- Left Branding -->
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900">TPC Platform</h1>
                    <p class="text-xs text-gray-600">Training & Placement Cell</p>
                </div>
            </div>

            <!-- Center Nav Links -->
            <div class="flex items-center space-x-6">

                <!-- ‚úÖ Home Button -->
                <a href="/homepage" class="text-gray-700 hover:text-blue-600 font-medium">Home</a>

                <!-- Shared Links (for everyone logged in) -->
                <a href="/companies" class="text-gray-700 hover:text-blue-600 font-medium">Company Listing</a>

                <a th:if="${student != null}" href="/opportunities" class="text-gray-700 hover:text-blue-600 font-medium">Opportunities</a>
                
                <a href="/notices" class="text-gray-700 hover:text-blue-600 font-medium">Notices</a>

                <a href="/student" class="text-gray-700 hover:text-blue-600 font-medium">Students</a>

                <a href="/resources" class="text-gray-700 hover:text-blue-600 font-medium">Resources</a>

                <a th:if="${student != null}" href="/schedule" class="text-gray-700 hover:text-blue-600 font-medium">Schedule</a>

                <!-- TPR-specific links -->
                <a th:if="${tpr != null}" href="/duties" class="text-gray-700 hover:text-blue-600 font-medium">Duties</a>
                <a th:if="${tpr != null}" href="/conductedat" class="text-gray-700 hover:text-blue-600 font-medium">Test Allotments</a>
                <a th:if="${tpr != null}" href="/tprtoken" class="text-gray-700 hover:text-blue-600 font-medium">Tokens</a>

            </div>

            <!-- Right Profile / Login buttons -->
            <div class="flex items-center space-x-3">
                <!-- For logged-in Student -->
                <a th:if="${student != null}" href="/profile"
                   class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm">Profile</a>
                <!-- <a th:if="${student != null}" href="/logout"
                   class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700">Logout</a> -->

                <!-- For logged-in TPR -->
                <a th:if="${tpr != null}" href="/tpr-profile"
                   class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm">Profile</a>
                <!-- <a th:if="${tpr != null}" href="/logout"
                   class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700">Logout</a> -->

                <!-- For guests -->
                <a th:if="${tpr == null and student == null}" href="/login"
                   class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">Login</a>
            </div>

        </div>
    </div>
</nav>
    <!-- Header -->
    <section class="gradient-bg text-white py-10">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <h1 class="text-4xl font-bold mb-3">Company Preference Selection</h1>
            <p class="text-blue-100 mb-4">Select a date to view your assessments and arrange them by preference</p>

            <div class="bg-blue-800 bg-opacity-50 rounded-lg p-4 inline-block">
                <label for="date-selector" class="text-blue-100 mr-2">üìÖ Select Date:</label>
                <input type="date" id="date-selector"
                       class="bg-blue-900 text-white p-2 rounded-md border border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-300">
            </div>
        </div>
    </section>

    <!-- Main -->
    <div class="max-w-5xl mx-auto px-6 py-10">
        <!-- Instructions -->
        <div class="bg-blue-50 rounded-xl p-6 mb-8">
            <h3 class="text-lg font-semibold text-blue-900 mb-2">How it works:</h3>
            <ul class="text-blue-800 space-y-1">
                <li>‚Ä¢ Choose a date from the selector above.</li>
                <li>‚Ä¢ Drag and drop companies to reorder your preferences.</li>
                <li>‚Ä¢ Top of the list = Highest priority.</li>
                <li>‚Ä¢ Click ‚ÄúSubmit Preferences‚Äù to save your order.</li>
            </ul>
        </div>

        <!-- Companies container -->
        <div id="slot-container" class="bg-white rounded-xl shadow-lg p-6 min-h-[200px]">
            <h3 id="slot-title" class="text-2xl font-bold text-gray-900 mb-6 hidden">Assessments for Selected Day</h3>
            <div id="companies-container" class="space-y-4" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
        </div>

        <!-- Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 justify-end mt-8">
            <button onclick="resetPreferences()"
                    class="bg-red-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-red-700 transition-colors">
                Reset
            </button>
            <button onclick="submitPreferences()"
                    class="bg-blue-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                Submit Preferences
            </button>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
    const apiUrl = '/api/preferences';
    let currentDate = null;
    let currentAssessments = [];
    let originalAssessments = [];

    // Date selector handler
    document.getElementById('date-selector').addEventListener('change', async (e) => {
        currentDate = e.target.value;
        await loadAssessments(currentDate);
    });

    async function loadAssessments(date) {
        const container = document.getElementById('companies-container');
        const title = document.getElementById('slot-title');
        container.innerHTML = '<p class="text-gray-600 text-center py-6">Loading assessments...</p>';
        title.classList.add('hidden');

        try {
            const res = await fetch(`${apiUrl}?date=${date}`);
            if (!res.ok) throw new Error('Failed to fetch');
            const data = await res.json();

            // Keep both original and current copies
            originalAssessments = JSON.parse(JSON.stringify(data));
            currentAssessments = JSON.parse(JSON.stringify(data));

            renderAssessments(currentAssessments);
        } catch (err) {
            container.innerHTML = `<p class="text-red-500 text-center py-6">Error loading data.</p>`;
        }
    }

    function renderAssessments(assessments) {
        const container = document.getElementById('companies-container');
        const title = document.getElementById('slot-title');
        container.innerHTML = '';
        title.classList.remove('hidden');

        if (assessments.length === 0) {
            container.innerHTML = `<p class="text-gray-600 text-center py-8">No assessments scheduled for this date.</p>`;
            return;
        }

        assessments.forEach((a, idx) => {
            const item = document.createElement('div');
            item.className = 'company-item bg-gray-50 border-2 border-gray-200 rounded-lg p-4';
            item.setAttribute('draggable', true);
            item.setAttribute('data-id', a.id);
            item.ondragstart = drag;
            item.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="priority-badge text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">${idx + 1}</div>
                        <div>
                            <h4 class="text-lg font-bold text-gray-900">${a.company}</h4>
                            <p class="text-gray-600">${a.title} ‚Ä¢ ${a.type}</p>
                            <p class="text-sm text-gray-500">${a.start_time.slice(11,16)} - ${a.end_time.slice(11,16)}</p>
                        </div>
                    </div>
                    <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium">
                        ${idx === 0 ? 'High Priority' : 'Low Priority'}
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
    }

    // --- Drag and drop logic ---
    let draggedElement = null;

    function drag(event) {
        draggedElement = event.target;
        event.target.classList.add('dragging');
    }

    function allowDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.add('drag-over');
    }

    function drop(event) {
        event.preventDefault();
        const container = document.getElementById('companies-container');
        container.classList.remove('drag-over');

        const afterElement = getDragAfterElement(container, event.clientY);
        if (draggedElement) {
            if (afterElement == null) {
                container.appendChild(draggedElement);
            } else {
                container.insertBefore(draggedElement, afterElement);
            }
        }
        draggedElement.classList.remove('dragging');
        draggedElement = null;
        updatePriorities();
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.company-item:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function updatePriorities() {
        document.querySelectorAll('.company-item').forEach((item, i) => {
            item.querySelector('.priority-badge').textContent = i + 1;
            const tag = item.querySelector('.bg-blue-100, .bg-gray-100');
            if (i === 0) {
                tag.textContent = 'High Priority';
                tag.className = 'bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium';
            } else {
                tag.textContent = 'Low Priority';
                tag.className = 'bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-xs font-medium';
            }
        });
    }

    function resetPreferences() {
        if (confirm('Reset preferences to original order?')) {
            // Re-render from original data
            currentAssessments = JSON.parse(JSON.stringify(originalAssessments));
            renderAssessments(originalAssessments);
        }
    }

    async function submitPreferences() {
        const order = [...document.querySelectorAll('.company-item')].map(i => i.dataset.id);
        if (!currentDate || order.length === 0) {
            alert('Please select a date and arrange at least one company.');
            return;
        }

        try {
            const res = await fetch(`${apiUrl}/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: currentDate, order })
            });

            if (!res.ok) throw new Error('Failed to save');
            alert('‚úÖ Preferences saved successfully!');
        } catch (err) {
            alert('‚ùå Failed to save preferences.');
        }
    }
</script>

</body>
</html>
