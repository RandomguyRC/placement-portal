<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tokens - Digital Campus Placement Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #1e40af 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-approved {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-rejected {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-in-progress {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16 min-w-0">
                <div class="flex items-center space-x-3 flex-shrink-0">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <div class="hidden sm:block">
                        <h1 class="text-lg font-bold text-gray-900 leading-tight">TPC Platform</h1>
                        <p class="text-xs text-gray-600 leading-tight">Training & Placement Cell</p>
                    </div>
                </div>

                <div class="flex items-center space-x-4 lg:space-x-6 xl:space-x-8 flex-shrink min-w-0">
                    <a href="/" class="text-gray-700 hover:text-blue-600 font-medium transition-colors text-sm lg:text-base whitespace-nowrap">Home</a>
                    <a href="/companies" class="text-gray-700 hover:text-blue-600 font-medium transition-colors text-sm lg:text-base whitespace-nowrap">Company Listing</a>
                    <a href="/opportunities" class="text-gray-700 hover:text-blue-600 font-medium transition-colors text-sm lg:text-base whitespace-nowrap">Opportunities</a>
                    <a href="/notices" class="text-gray-700 hover:text-blue-600 font-medium transition-colors text-sm lg:text-base whitespace-nowrap">Notices</a>
                    <a href="/student" class="text-gray-700 hover:text-blue-600 font-medium transition-colors text-sm lg:text-base whitespace-nowrap">Students</a>
                    <a href="/resources" class="text-gray-700 hover:text-blue-600 font-medium transition-colors text-sm lg:text-base whitespace-nowrap">Resources</a>
                    <a href="/profile" class="text-gray-700 hover:text-blue-600 font-medium transition-colors text-sm lg:text-base whitespace-nowrap">Profile</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header Section -->
    <div class="gradient-bg text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h1 class="text-4xl font-bold mb-4">My Support Tokens</h1>
                <p class="text-xl text-blue-100 mb-6">Track and manage your support requests</p>
                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4 inline-block">
                    <p id="tokenStats" class="text-lg font-medium">
                        Student ID: ‚Äî | Total Tokens: ‚Äî
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Controls -->
        <div class="mb-8 flex flex-wrap gap-4 items-center justify-between">
            <div class="flex items-center space-x-4">
                <!-- <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="in-progress">In Progress</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
                <select id="categoryFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">All Categories</option>
                    <option value="placement">Placement Query</option>
                    <option value="technical">Technical Issue</option>
                    <option value="document">Document Request</option>
                    <option value="general">General Support</option>
                </select> -->
                <button onclick="createNewToken()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    New Token
                </button>
            </div>
            <div class="flex items-center space-x-6 text-sm">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                    <span>Pending</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                    <span>In Progress</span>
                </div>
            </div>
        </div>

        <!-- Tokens Grid -->
<div id="tokensGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
    <div class="col-span-full text-center text-gray-400">
        Loading your tokens...
    </div>
</div>


        
    <div id="tokenModal" class="modal">
        <div class="modal-content p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-900">Token Details</h2>
                <button onclick="closeTokenModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="modalContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
    <!-- Create Token Modal -->
<div id="createTokenModal" class="modal">
  <div class="modal-content p-6">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-900">Create New Token</h2>
      <button onclick="closeCreateTokenModal()" class="text-gray-400 hover:text-gray-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <form id="createTokenForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
        <input type="text" id="newTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
        <textarea id="newDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required></textarea>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
          <select id="newCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="placement">Placement Query</option>
            <option value="technical">Technical Issue</option>
            <option value="document">Document Request</option>
            <option value="general" selected>General Support</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
          <select id="newPriority" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="Low">Low</option>
            <option value="Normal" selected>Normal</option>
            <option value="High">High</option>
          </select>
        </div>
      </div>

      <div class="flex justify-end space-x-3 mt-6">
        <button type="button" onclick="closeCreateTokenModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Create Token</button>
      </div>
    </form>
  </div>
</div>
    <!-- Toast Notification -->
<div id="toastContainer" class="fixed top-4 right-4 z-[2000] space-y-2"></div>
<script>
let studentId = null;

// üß† Try to read logged-in student info from server
async function checkLoginStatus() {
  try {
    const res = await fetch("/session/student");
    if (res.status === 401) {
      alert("You must be logged in to access My Tokens.");
      window.location.href = "/login";
      return;
    }

    const data = await res.json();
    studentId = data.enrollmentNumber;
    loadTokens();
  } catch (err) {
    console.error("Error checking login:", err);
    alert("Unable to verify login. Redirecting to login page.");
    window.location.href = "/login";
  }
}

window.onload = checkLoginStatus;
</script>

    <script>
// const studentId = "23075063"; // TODO: replace with session-based value later

// Load all tokens for this student
async function loadTokens() {
  try {
    const response = await fetch(`/api/tokens/${studentId}`);
    if (!response.ok) throw new Error("Failed to fetch tokens");

    const tokens = await response.json();
    const grid = document.getElementById("tokensGrid");
    grid.innerHTML = "";

    // üßÆ Calculate stats
    const total = tokens.length;
    const pending = tokens.filter(t => t.status === "Pending").length;
    const inProgress = tokens.filter(t => t.status === "In Progress").length;
    const resolved = tokens.filter(t => t.status === "Resolved" || t.status === "Approved").length;
    const rejected = tokens.filter(t => t.status === "Rejected").length;

    // üß† Update header stats dynamically
    document.getElementById("tokenStats").innerText =
      `Student ID: ${studentId} | Total: ${total} | Pending: ${pending} | In Progress: ${inProgress} | Resolved: ${resolved} | Rejected: ${rejected}`;

    // üß± Render tokens
    if (tokens.length === 0) {
      grid.innerHTML = `<div class="col-span-full text-center text-gray-400">No tokens found.</div>`;
      return;
    }

    tokens.forEach(token => {
      const statusClassMap = {
        "Pending": "status-pending",
        "In Progress": "status-in-progress",
        "Approved": "status-approved",
        "Resolved": "status-approved",
        "Rejected": "status-rejected"
      };
      const statusClass = statusClassMap[token.status] || "status-pending";

      const createdAt = token.createdAt ? new Date(token.createdAt).toLocaleDateString() : "-";
      const updatedAt = token.updatedAt ? new Date(token.updatedAt).toLocaleDateString() : "-";

      grid.innerHTML += `
        <div class="token-card bg-white rounded-lg shadow-lg p-6 card-hover cursor-pointer"
             data-status="${token.status?.toLowerCase() || 'pending'}"
             data-category="${token.category?.toLowerCase() || 'general'}"
             onclick="openTokenModal('${token.tokenId}')">
          <div class="flex items-center justify-between mb-4">
            <div class="text-lg font-bold text-gray-900">${token.tokenId}</div>
            <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
              ${token.status}
            </span>
          </div>
          <div class="mb-4">
            <h3 class="font-semibold text-gray-800 mb-2">${token.title || 'Untitled Token'}</h3>
            <p class="text-gray-600 text-sm">${token.description || 'No description available.'}</p>
          </div>
          <div class="space-y-2 text-sm text-gray-500">
            <div class="flex justify-between">
              <span>Category:</span>
              <span class="font-medium">${token.category || '-'}</span>
            </div>
            <div class="flex justify-between">
              <span>Created:</span>
              <span class="font-medium">${createdAt}</span>
            </div>
            <div class="flex justify-between">
              <span>Last Updated:</span>
              <span class="font-medium">${updatedAt}</span>
            </div>
          </div>
        </div>`;
    });
  } catch (err) {
    console.error("Error loading tokens:", err);
    document.getElementById("tokensGrid").innerHTML = `
      <div class="col-span-full text-center text-gray-500 py-8">
        Failed to load tokens. Please try again later.
      </div>`;
  }
}


// Load tokens when page opens
</script>
<script>
function createNewToken() {
  document.getElementById("createTokenModal").classList.add("show");
}

function closeCreateTokenModal() {
  document.getElementById("createTokenModal").classList.remove("show");
}

// Handle form submission
// ‚úÖ Handle "Create Token" with double-click prevention
document.getElementById("createTokenForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const createBtn = e.target.querySelector("button[type='submit']");
  createBtn.disabled = true;
  const originalText = createBtn.innerText;
  createBtn.innerText = "Creating...";

  const token = {
    studentId: studentId,
    title: document.getElementById("newTitle").value.trim(),
    description: document.getElementById("newDescription").value.trim(),
    category: document.getElementById("newCategory").value,
    priority: document.getElementById("newPriority").value
  };

  try {
    const response = await fetch("/api/tokens/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(token)
    });

    if (!response.ok) throw new Error("Failed to create token");

    showToast("‚úÖ Token created successfully!", "success");
    closeCreateTokenModal();
    loadTokens(); // refresh grid
  } catch (err) {
    console.error("Error creating token:", err);
    showToast("‚ùå Failed to create token. Please try again.", "error");
  } finally {
    // ‚úÖ Re-enable button safely
    createBtn.disabled = false;
    createBtn.innerText = originalText;
  }
});
</script>
<script>
function showToast(message, type = "info") {
  const container = document.getElementById("toastContainer");
  if (!container) return;

  const colors = {
    success: "bg-green-100 text-green-800 border-green-400",
    error: "bg-red-100 text-red-800 border-red-400",
    info: "bg-blue-100 text-blue-800 border-blue-400",
  };

  const toast = document.createElement("div");
  toast.className = `border px-4 py-3 rounded-lg shadow-md ${colors[type]} transition-opacity duration-500`;
  toast.innerHTML = `
    <div class="flex items-center justify-between">
      <span class="font-medium">${message}</span>
      <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-sm text-gray-500 hover:text-gray-700">‚úï</button>
    </div>
  `;

  container.appendChild(toast);

  // Auto-hide after 3 seconds
  setTimeout(() => {
    toast.style.opacity = "0";
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}
</script>
<script>
let allTokens = [];

// ‚úÖ Modify loadTokens() slightly to store all tokens globally
async function loadTokens() {
  try {
    const response = await fetch(`/api/tokens/${studentId}`);
    if (!response.ok) throw new Error("Failed to fetch tokens");

    const tokens = await response.json();
    allTokens = tokens; // üîπ store globally

    // üßÆ Calculate stats
    const total = tokens.length;
    const pending = tokens.filter(t => t.status === "Pending").length;
    const resolved = tokens.filter(t => t.status === "Resolved").length;

    // üß† Update header stats
    document.getElementById("tokenStats").innerText =
      `Student ID: ${studentId} | Total: ${total} | Pending: ${pending} | Resolved: ${resolved}`;

    const grid = document.getElementById("tokensGrid");
    grid.innerHTML = "";

    if (tokens.length === 0) {
      grid.innerHTML = `<div class="col-span-full text-center text-gray-400">No tokens found.</div>`;
      return;
    }

    tokens.forEach(token => {
      const statusClassMap = {
        "Pending": "status-pending",
        "Resolved": "status-approved",
        "Approved": "status-approved",
        "Rejected": "status-rejected",
      };
      const statusClass = statusClassMap[token.status] || "status-pending";

      grid.innerHTML += `
        <div class="token-card bg-white rounded-lg shadow-lg p-6 card-hover cursor-pointer"
             onclick="openTokenModal('${token.tokenId}')">
          <div class="flex items-center justify-between mb-4">
            <div class="text-lg font-bold text-gray-900">${token.tokenId}</div>
            <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
              ${token.status}
            </span>
          </div>
          <div class="mb-3">
            <h3 class="font-semibold text-gray-800 mb-1">${token.title || 'Untitled'}</h3>
            <p class="text-gray-600 text-sm line-clamp-2">${token.description || 'No description.'}</p>
          </div>
          <div class="text-sm text-gray-500 flex justify-between">
            <span>${token.category || '-'}</span>
            <span>${new Date(token.createdAt).toLocaleDateString()}</span>
          </div>
        </div>`;
    });
  } catch (err) {
    console.error(err);
  }
}


// ‚úÖ Open modal with details
function openTokenModal(tokenId) {
  const token = allTokens.find(t => t.tokenId === tokenId);
  if (!token) return;

  const modal = document.getElementById("tokenModal");
  const content = document.getElementById("modalContent");
  document.getElementById("modalTitle").innerText = `Token ${token.tokenId}`;

  const created = token.createdAt ? new Date(token.createdAt).toLocaleString() : "-";
  const resolved = token.resolvedAt ? new Date(token.resolvedAt).toLocaleString() : "-";

  content.innerHTML = `
    <div class="space-y-3 text-gray-800">
      <div><span class="font-semibold">Title:</span> ${token.title}</div>
      <div><span class="font-semibold">Description:</span><br>${token.description}</div>
      <div><span class="font-semibold">Category:</span> ${token.category}</div>
      <div><span class="font-semibold">Priority:</span> ${token.priority}</div>
      <div><span class="font-semibold">Status:</span> ${token.status}</div>
      <div><span class="font-semibold">Assigned To:</span> ${token.assignedTo || '-'}</div>
      <div><span class="font-semibold">TPR Reply:</span><br>${token.tprReply || '‚Äî No reply yet ‚Äî'}</div>
      <hr class="my-2">
      <div class="text-sm text-gray-600">
        <div>Created At: ${created}</div>
        <div>Last Updated: ${token.updatedAt ? new Date(token.updatedAt).toLocaleString() : '-'}</div>
        <div>Resolved At: ${resolved}</div>
      </div>
    </div>
  `;

  modal.classList.add("show");
}

// ‚úÖ Close modal
function closeTokenModal() {
  document.getElementById("tokenModal").classList.remove("show");
}
</script>


<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9812c2d32427dc7f',t:'MTc1ODIxODYxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
