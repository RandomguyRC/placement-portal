<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TPC Platform — OA Schedule</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .card-hover { transition: transform .25s ease, box-shadow .25s ease; }
    .card-hover:hover { transform: translateY(-3px); box-shadow: 0 16px 40px rgba(0,0,0,.08); }
    .status-dot { width: 10px; height: 10px; border-radius: 9999px; display: inline-block; }
    .badge { padding: 2px 8px; border-radius: 9999px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap;}
    .badge-upcoming { background:#ecfeff; color:#0e7490; border:1px solid #a5f3fc; }
    .dot-upcoming { background:#06b6d4; }
    .badge-ongoing { background:#f0fdf4; color:#166534; border:1px solid #bbf7d0; }
    .dot-ongoing { background:#22c55e; }
    .badge-completed { background:#f8fafc; color:#334155; border:1px solid #cbd5e1; }
    .dot-completed { background:#64748b; }
    .table-head { background: #f8fafc; }
    .pill { border: 1px solid rgba(0,0,0,.08); background: white; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- Navigation Header (reused) -->
  <nav class="bg-white shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16 min-w-0">
        <div class="flex items-center space-x-3 flex-shrink-0">
          <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
            </svg>
          </div>
          <div class="hidden sm:block">
            <h1 class="text-lg font-bold text-gray-900 leading-tight">TPC Platform</h1>
            <p class="text-xs text-gray-600 leading-tight">Training & Placement Cell</p>
          </div>
        </div>

        <div class="flex items-center space-x-4 lg:space-x-6 xl:space-x-8 flex-shrink min-w-0">
          <a href="/" class="text-gray-700 hover:text-blue-600 font-medium transition-colors text-sm lg:text-base whitespace-nowrap">Home</a>
          <a href="/companies" class="text-gray-700 hover:text-blue-600 font-medium transition-colors text-sm lg:text-base whitespace-nowrap">Company Listing</a>
          <a href="/opportunities" class="text-gray-700 hover:text-blue-600 font-medium transition-colors text-sm lg:text-base whitespace-nowrap">Opportunities</a>
          <a href="/notices" class="text-gray-700 hover:text-blue-600 font-medium transition-colors text-sm lg:text-base whitespace-nowrap">Notices</a>
          <a href="/students" class="text-gray-700 hover:text-blue-600 font-medium transition-colors text-sm lg:text-base whitespace-nowrap">Students</a>
          <a href="/resources" class="text-gray-700 hover:text-blue-600 font-medium transition-colors text-sm lg:text-base whitespace-nowrap">Resources</a>
          <a href="/schedule" class="text-gray-700 hover:text-blue-600 font-medium transition-colors text-sm lg:text-base whitespace-nowrap">Schedule</a>
        

        <div class="flex-shrink-0">
          <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm">
            Login
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Page Header -->
  <header class="gradient-bg text-white">
    <div class="max-w-7xl mx-auto px-6 py-10">
      <div class="flex flex-col md:flex-row md:items-end gap-4 md:gap-6">
        <div>
          <h2 class="text-3xl md:text-4xl font-extrabold tracking-tight">OA Schedule</h2>
          <p class="mt-2 text-white/90 max-w-2xl">View all Online Assessments that are upcoming or completed. Manage attendance for each OA with one click.</p>
        </div>
        <div class="md:ml-auto">
          <div class="grid sm:grid-cols-2 gap-3">
            <button id="addOA" class="px-4 py-2.5 rounded-lg bg-white/10 hover:bg-white/20 border border-white/30 font-semibold backdrop-blur text-white">Add OA (Sample)</button>
            <a href="#reports" class="px-4 py-2.5 rounded-lg bg-white text-blue-900 font-semibold hover:bg-blue-50">Reports</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Controls -->
  <section class="max-w-7xl mx-auto px-6 -mt-6 relative z-10">
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 md:p-5 card-hover">
      <div class="flex flex-col md:flex-row gap-4 md:items-center">
        <div class="flex-1">
          <label class="sr-only" for="search">Search</label>
          <div class="relative">
            <input id="search" type="text" placeholder="Search OA by title or company..." class="w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-600">
            <svg class="w-5 h-5 absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" viewBox="0 0 24 24" fill="none">
              <path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
        </div>
        <div class="flex gap-3 flex-wrap">
          <select id="statusFilter" class="pill rounded-lg px-3 py-2 text-sm">
            <option value="all">All statuses</option>
            <option value="upcoming">Upcoming</option>
            <option value="ongoing">Ongoing</option>
            <option value="completed">Completed</option>
          </select>
          <select id="venueFilter" class="pill rounded-lg px-3 py-2 text-sm">
            <option value="all">All venues</option>
          </select>
          <button id="resetFilters" class="rounded-lg px-3 py-2 text-sm border border-gray-300 bg-white hover:bg-gray-50">Reset</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Table -->
  <main class="max-w-7xl mx-auto px-6 py-8">
    <div class="overflow-hidden bg-white rounded-2xl border border-gray-200 shadow-sm">
      <div class="overflow-x-auto">
        <table class="min-w-full whitespace-nowrap">
          <thead class="table-head">
            <tr>
              <th class="text-left px-6 py-3 text-xs font-semibold text-gray-500">OA</th>
              <th class="text-left px-6 py-3 text-xs font-semibold text-gray-500">Date</th>
              <th class="text-left px-6 py-3 text-xs font-semibold text-gray-500">Time</th>
              <th class="text-left px-6 py-3 text-xs font-semibold text-gray-500">Venue</th>
              <th class="text-left px-6 py-3 text-xs font-semibold text-gray-500">Registered</th>
              <th class="text-left px-6 py-3 text-xs font-semibold text-gray-500">Status</th>
              <th class="text-right px-6 py-3 text-xs font-semibold text-gray-500">Actions</th>
            </tr>
          </thead>
          <tbody id="oaBody" class="divide-y divide-gray-100">
            <!-- Rows injected by JS -->
          </tbody>
        </table>
      </div>

      <!-- Empty state -->
      <div id="emptyState" class="hidden p-10 text-center text-gray-600">
        <div class="mx-auto w-12 h-12 rounded-xl bg-gray-100 flex items-center justify-center mb-3">
          <svg class="w-6 h-6 text-gray-500" viewBox="0 0 24 24" fill="none">
            <path d="M3 7h18M3 12h18M3 17h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <p class="font-semibold">No OAs found</p>
        <p class="text-sm">Try adjusting filters or clearing the search.</p>
      </div>
    </div>

    <!-- Legend -->
    <div class="mt-4 text-sm text-gray-600 flex flex-wrap items-center gap-3">
      <span class="badge badge-upcoming"><span class="status-dot dot-upcoming"></span> Upcoming</span>
      <span class="badge badge-ongoing"><span class="status-dot dot-ongoing"></span> Ongoing</span>
      <span class="badge badge-completed"><span class="status-dot dot-completed"></span> Completed</span>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t">
    <div class="max-w-7xl mx-auto px-6 py-8 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
          </svg>
        </div>
        <div>
          <p class="font-semibold text-gray-900">TPC Platform</p>
          <p class="text-xs text-gray-600">OA Schedule</p>
        </div>
      </div>
      <div class="text-sm text-gray-600">© <span id="year"></span> All rights reserved.</div>
    </div>
  </footer>

<script>
  // --- Utility: display current year ---
  document.getElementById('year').textContent = new Date().getFullYear();

  // --- Login Button (can be removed later) ---
  document.getElementById('loginBtn').addEventListener('click', () => {
    alert('Navigate to Login page');
  });

  // --- DOM Elements ---
  const tbody = document.getElementById('oaBody');
  const venueFilter = document.getElementById('venueFilter');
  const statusFilter = document.getElementById('statusFilter');
  const searchInput = document.getElementById('search');
  const resetBtn = document.getElementById('resetFilters');
  let oaData = [];

  // --- Load Schedule from Backend ---
  async function loadSchedule() {
    try {
      // ✅ Fetch logged-in student's data from session
      const res = await fetch('/session/student', { credentials: 'include' });
      let enrollmentNumber = null;

      if (res.ok) {
        const studentData = await res.json();
        enrollmentNumber = studentData.enrollmentNumber;
      }

      // fallback if not in session
      if (!enrollmentNumber) {
        console.warn('No session found. Please log in again.');
        toggleEmptyState(true);
        return; // stop loading
      }

      // ✅ Fetch schedule from backend
      const scheduleRes = await fetch(`/api/schedule/${enrollmentNumber}`);
      if (!scheduleRes.ok) throw new Error('Failed to load schedule');
      const data = await scheduleRes.json();

      // ✅ Map to match UpcomingAssessmentDTO structure
      oaData = data.schedules.map((item, index) => ({
        id: index + 1,
        title: `${item.companyName} — ${item.jobRole || item.type || 'Assessment'}`,
        company: item.companyName,
        date: item.startTime ? item.startTime.split('T')[0] : '-',          // extract date part
        time: item.startTime ? item.startTime.split('T')[1]?.slice(0, 5) : '-', // extract HH:MM part
        venue: item.modeOfHiring || 'Online / TBA',
        registered: '—',
        status: computeStatus(item.startTime, item.endTime)
      }));

      // Build venue dropdown
      const venues = Array.from(new Set(oaData.map(o => o.venue)));
      venues.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        venueFilter.appendChild(opt);
      });

      applyFilters();
    } catch (err) {
      console.error(err);
      toggleEmptyState(true);
    }
  }

  // --- Helper Functions ---
  function computeStatus(startTime, endTime) {
    try {
      const now = new Date();
      const start = new Date(startTime);
      const end = endTime ? new Date(endTime) : null;
      if (now < start) return 'upcoming';
      if (end && now <= end) return 'ongoing';
      return 'completed';
    } catch {
      return 'upcoming';
    }
  }

  function statusBadge(status) {
    if (status === 'upcoming')
      return '<span class="badge badge-upcoming"><span class="status-dot dot-upcoming"></span>Upcoming</span>';
    if (status === 'ongoing')
      return '<span class="badge badge-ongoing"><span class="status-dot dot-ongoing"></span>Ongoing</span>';
    return '<span class="badge badge-completed"><span class="status-dot dot-completed"></span>Completed</span>';
  }

  function renderRows(rows) {
  tbody.innerHTML = '';
  rows.forEach(item => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-6 py-4">
        <div class="min-w-[220px]">
          <p class="font-semibold text-gray-900">${item.title}</p>
          <p class="text-xs text-gray-500">${item.company}</p>
        </div>
      </td>
      <td class="px-6 py-4 text-sm">${item.date || '-'}</td>
      <td class="px-6 py-4 text-sm">${item.time || '-'}</td>
      <td class="px-6 py-4 text-sm">${item.venue}</td>
      <td class="px-6 py-4 font-semibold">${item.registered}</td>
      <td class="px-6 py-4">${statusBadge(item.status)}</td>
      <td class="px-6 py-4 text-right space-x-2">
        <button data-listing="${item.id}" class="sitting-btn px-3 py-2 rounded-lg bg-blue-50 text-blue-600 text-sm font-semibold hover:bg-blue-100 transition">
          Sitting Plan
        </button>
        <button data-id="${item.id}" class="attendance-btn px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition">
          Attendance
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  toggleEmptyState(rows.length === 0);

  // --- Add sitting plan button listener ---
  document.querySelectorAll('.sitting-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const listingId = e.target.getAttribute('data-listing');
      showSittingPlan(listingId);
    });
  });
}

// --- Popup Grid for Sitting Plan ---
async function showSittingPlan(listingId) {
  try {
    const res = await fetch(`/api/sitting-plan/${listingId}`);
    if (!res.ok) throw new Error('Failed to fetch sitting plan');
    const data = await res.json();

    const { grid, rows, columns } = data;

    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
    overlay.innerHTML = `
      <div class="bg-white rounded-2xl shadow-xl max-w-5xl w-full p-6 relative">
        <button class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
        <h2 class="text-xl font-semibold mb-4 text-gray-800">
          Sitting Plan — Listing ID: ${listingId}
        </h2>
        <div class="grid" style="grid-template-columns: repeat(${columns}, minmax(0, 1fr)); gap: 10px;">
          ${grid.flat().map(seat => seat
            ? `<div class="border rounded-lg p-2 text-center bg-gray-50 hover:bg-blue-50 transition">
                 <p class="font-semibold text-gray-900">${seat}</p>
               </div>`
            : `<div class="border rounded-lg p-2 bg-gray-100 opacity-50"></div>`
          ).join('')}
        </div>
      </div>
    `;

    document.body.appendChild(overlay);

    overlay.querySelector('button').addEventListener('click', () => overlay.remove());
    overlay.addEventListener('click', e => {
      if (e.target === overlay) overlay.remove();
    });

  } catch (err) {
    console.error(err);
    alert('Unable to load sitting plan.');
  }
}



  function toggleEmptyState(show) {
    document.getElementById('emptyState').classList.toggle('hidden', !show);
  }

  function applyFilters() {
    const term = searchInput.value.trim().toLowerCase();
    const status = statusFilter.value;
    const venue = venueFilter.value;
    const filtered = oaData.filter(o => {
      const matchesTerm = !term || (o.title.toLowerCase().includes(term) || o.company.toLowerCase().includes(term));
      const matchesStatus = status === 'all' || o.status === status;
      const matchesVenue = venue === 'all' || o.venue === venue;
      return matchesTerm && matchesStatus && matchesVenue;
    });
    renderRows(filtered);
  }

  searchInput.addEventListener('input', applyFilters);
  statusFilter.addEventListener('change', applyFilters);
  venueFilter.addEventListener('change', applyFilters);
  resetBtn.addEventListener('click', () => {
    searchInput.value = '';
    statusFilter.value = 'all';
    venueFilter.value = 'all';
    applyFilters();
  });

  // --- Load Data on Page Load ---
  loadSchedule();
</script>


<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'980261d0c3ac5983',t:'MTc1ODA0Njg3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
