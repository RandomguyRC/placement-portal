<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Opportunities</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

<nav class="bg-white shadow p-4">
    <div class="max-w-6xl mx-auto">
        <span class="text-xl font-semibold text-blue-700">TPC Platform â€” Opportunities</span>
    </div>
</nav>

<div class="max-w-6xl mx-auto py-8">
    <div th:if="${notLoggedIn}" class="bg-yellow-100 border border-yellow-300 text-yellow-900 p-4 rounded mb-6">
        You are not logged in. Please <a href="/login" class="text-blue-600 underline">log in</a> to see eligible opportunities.
    </div>

    <h1 class="text-2xl font-bold mb-6">Opportunities you're eligible for</h1>

    <div th:if="${jobListings == null or #lists.isEmpty(jobListings)}" class="text-gray-600">
        No eligible job listings found.
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div th:each="job : ${jobListings}" class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold" th:text="${job.jobRole}">Job Role</h2>
            <p class="text-sm text-gray-600" th:text="${job.jobDescription}">Description</p>

            <p class="mt-2 text-sm">
                <strong>Company:</strong> <span th:text="${job.company.companyName}">Company</span>
            </p>
            <p class="text-sm"><strong>CTC:</strong> <span th:text="${job.ctc}">CTC</span></p>
            <p class="text-sm"><strong>Mode:</strong> <span th:text="${job.modeOfHiring}">Mode</span></p>
            <p class="text-sm"><strong>Deadline:</strong>
                <span th:text="${job.deadline != null ? #temporals.format(job.deadline,'dd MMM yyyy HH:mm') : 'TBA'}">Deadline</span>
            </p>

            <!-- appliedMap used to disable button when already applied -->
            <div class="mt-4">
    <button
        th:attr="data-listing-id=${job.listingId},data-applied=${appliedMap[job.listingId]}"
        th:classappend="${appliedMap[job.listingId]} ? ' bg-gray-400 cursor-not-allowed' : ' bg-blue-600 hover:bg-blue-700'"
        th:text="${appliedMap[job.listingId]} ? 'Applied' : 'Apply'"
        onclick="applyForJob(this.getAttribute('data-listing-id'), this)"
        class="text-white px-4 py-2 rounded">
        Apply
    </button>
</div>


<!-- message box -->
<div id="messageBox" class="fixed bottom-6 right-6 hidden px-4 py-3 rounded shadow text-white"></div>

<script>
    function showMessage(text, isError=false) {
        const box = document.getElementById('messageBox');
        box.textContent = text;
        box.classList.remove('hidden');
        box.style.backgroundColor = isError ? '#dc2626' : '#16a34a';
        setTimeout(()=> box.classList.add('hidden'), 3000);
    }

    async function applyForJob(listingId, btn) {
        // If already marked applied, ignore
        const applied = btn.getAttribute('data-applied') === 'true';
        if (applied) {
            showMessage('Already applied', true);
            return;
        }

        try {
            const res = await fetch(`/opportunities/apply/${listingId}`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const text = await res.text();
            if (text === 'success') {
                showMessage('Application submitted');
                btn.textContent = 'Applied';
                btn.setAttribute('data-applied', 'true');
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-400','cursor-not-allowed');
            } else if (text === 'error:not_logged_in') {
                showMessage('Please log in to apply', true);
                // optionally redirect to login
            } else if (text === 'error:already_applied') {
                showMessage('You already applied', true);
                btn.textContent = 'Applied';
                btn.setAttribute('data-applied', 'true');
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-400','cursor-not-allowed');
            } else {
                showMessage('Error applying', true);
            }
        } catch (e) {
            console.error(e);
            showMessage('Server error', true);
        }
    }
</script>

</body>
</html>
