<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPR Dashboard - Digital Campus Placement Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #1e40af 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-approved {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-rejected {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-in-progress {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .priority-high {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .priority-medium {
            background-color: #fef3c7;
            color: #92400e;
        }
        .priority-low {
            background-color: #f0f9ff;
            color: #1e40af;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .tab-active {
            background-color: #3b82f6;
            color: white;
        }
        .tab-inactive {
            background-color: #f3f4f6;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">

            <!-- Left Branding -->
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900">TPC Platform</h1>
                    <p class="text-xs text-gray-600">Training & Placement Cell</p>
                </div>
            </div>

            <!-- Center Nav Links -->
            <div class="flex items-center space-x-6">

                <!-- ✅ Home Button -->
                <a href="/homepage" class="text-gray-700 hover:text-blue-600 font-medium">Home</a>

                <!-- Shared Links (for everyone logged in) -->
                <a href="/companies" class="text-gray-700 hover:text-blue-600 font-medium">Company Listing</a>

                <a th:if="${student != null}" href="/opportunities" class="text-gray-700 hover:text-blue-600 font-medium">Opportunities</a>
                
                <a href="/notices" class="text-gray-700 hover:text-blue-600 font-medium">Notices</a>

                <a th:if="${student != null}" href="/student" class="text-gray-700 hover:text-blue-600 font-medium">Students</a>

                <a href="/resources" class="text-gray-700 hover:text-blue-600 font-medium">Resources</a>

                <a th:if="${student != null}" href="/schedule" class="text-gray-700 hover:text-blue-600 font-medium">Schedule</a>

                <!-- TPR-specific links -->
                <a th:if="${tpr != null}" href="/duties" class="text-gray-700 hover:text-blue-600 font-medium">Duties</a>
                <a th:if="${tpr != null}" href="/conductedat" class="text-gray-700 hover:text-blue-600 font-medium">Test Allotments</a>
                <a th:if="${tpr != null}" href="/tprtoken" class="text-gray-700 hover:text-blue-600 font-medium">Tokens</a>

            </div>

            <!-- Right Profile / Login buttons -->
            <div class="flex items-center space-x-3">
                <!-- For logged-in Student -->
                <a th:if="${student != null}" href="/profile"
                   class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm">Profile</a>
                <!-- <a th:if="${student != null}" href="/logout"
                   class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700">Logout</a> -->

                <!-- For logged-in TPR -->
                <a th:if="${tpr != null}" href="/tpr-profile"
                   class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm">Profile</a>
                <!-- <a th:if="${tpr != null}" href="/logout"
                   class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700">Logout</a> -->

                <!-- For guests -->
                <a th:if="${tpr == null and student == null}" href="/login"
                   class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">Login</a>
            </div>

        </div>
    </div>
</nav>


    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-blue-600 mb-2">15</div>
                <div class="text-gray-600">Total Tokens</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-yellow-600 mb-2">6</div>
                <div class="text-gray-600">Pending</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-blue-500 mb-2">4</div>
                <div class="text-gray-600">In Progress</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-red-600 mb-2">3</div>
                <div class="text-gray-600">High Priority</div>
            </div>
        </div>

        <!-- Filters and Controls -->
        <div class="mb-8 flex flex-wrap gap-4 items-center justify-between">
  <div class="flex items-center space-x-4">
    <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      <option value="all">All Status</option>
      <option value="pending">Pending</option>
      <option value="resolved">Resolved</option>
    </select>

    <select id="priorityFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      <option value="all">All Priority</option>
      <option value="low">Low</option>
      <option value="normal">Normal</option>
      <option value="high">High</option>
    </select>

    <select id="categoryFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      <option value="all">All Categories</option>
      <option value="placement">Placement Query</option>
      <option value="technical">Technical Issue</option>
      <option value="document">Document Request</option>
      <option value="general">General Support</option>
    </select>

    <input type="text" id="searchInput"
           placeholder="Search by student ID or token..."
           class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
  </div>

  <div class="flex items-center space-x-2">
    <button onclick="refreshTokens()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
      Refresh
    </button>
  </div>
</div>


        <!-- Tokens Table -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Student Support Tokens</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Token ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tokensTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Token Details Modal -->
<div id="tokenModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-lg p-6">
    <h2 id="modalTitle" class="text-xl font-semibold mb-2"></h2>
    <p class="text-sm text-gray-600 mb-4" id="modalDescription"></p>
    <div class="text-sm text-gray-500 mb-2">Student ID: <span id="modalStudent" class="font-medium text-gray-700"></span></div>
    <div class="text-sm text-gray-500 mb-2">Priority: <span id="modalPriority" class="font-medium text-gray-700"></span></div>
    <div class="text-sm text-gray-500 mb-4">Status: <span id="modalStatus" class="font-medium text-gray-700"></span></div>

    <div id="replySection">
      <textarea id="modalReply" rows="3" class="w-full border rounded-lg p-2 mb-3" placeholder="Enter your reply..."></textarea>
      <input type="hidden" id="modalTokenId">
      <button onclick="submitReply()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
        Reply & Resolve
      </button>
    </div>

    <button onclick="closeModal()" class="mt-3 text-gray-500 hover:text-gray-700 text-sm font-medium">Close</button>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const res = await fetch('/session/tpr');
    if (!res.ok) {
      // ❌ No TPR logged in
      window.location.href = '/login';
      return;
    }

    // ✅ Logged in — get TPR details
    const tpr = await res.json();

    // Optional: store for later use (if you need assigned_to = tpr.tprId)
    window.loggedInTpr = tpr;

    // ✅ Show logout, hide login
    const loginBtn = document.querySelector('#loginBtn');
    const logoutBtn = document.querySelector('#logoutBtn');
    if (loginBtn) loginBtn.style.display = 'none';
    if (logoutBtn) logoutBtn.style.display = 'inline-block';

  } catch (error) {
    console.error('Session check failed:', error);
    window.location.href = '/login';
  }
});
</script>

<script>
let allTokens = [];
let filteredTokens = [];

// helper: normalize strings for safe comparisons
function norm(s) {
    return (s || "").toString().trim().toLowerCase().replace(/[-_]+/g, " ");
}

// ✅ Fetch all tokens
async function fetchTokens() {
    try {
        const response = await fetch("/api/tokens/all");
        allTokens = await response.json();
        filteredTokens = [...allTokens];
        populateTokensTable(filteredTokens);
        updateStats(allTokens);
    } catch (error) {
        console.error("Error fetching tokens:", error);
    }
}

// ✅ Populate table
function populateTokensTable(tokens = filteredTokens) {
    const tbody = document.getElementById("tokensTableBody");
    tbody.innerHTML = "";

    if (!tokens || tokens.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-6 text-gray-500">No tokens found</td>
            </tr>`;
        return;
    }

    tokens.forEach(token => {
        const row = document.createElement("tr");
        row.className = "hover:bg-gray-50 transition";

        row.innerHTML = `
            <td class="px-6 py-4 text-sm text-gray-900">${token.tokenId}</td>
            <td class="px-6 py-4 text-sm text-gray-700">${token.studentId}</td>
            <td class="px-6 py-4 text-sm text-gray-700">${token.title}</td>
            <td class="px-6 py-4 text-sm text-gray-700">${token.category}</td>
            <td class="px-6 py-4">
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${getPriorityClass(token.priority)}">${token.priority}</span>
            </td>
            <td class="px-6 py-4">
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(token.status)}">${token.status}</span>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500">${token.createdAt ? new Date(token.createdAt).toLocaleDateString() : "-"}</td>
            <td class="px-6 py-4 text-sm font-medium">
                <button onclick="openTokenModal(${token.id})" class="text-blue-600 hover:text-blue-800 font-semibold">View</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// ✅ Update quick stats
function updateStats(tokens) {
    const total = tokens.length;
    const pending = tokens.filter(t => norm(t.status) === "pending").length;
    const resolved = tokens.filter(t => norm(t.status) === "resolved").length;
    // support legacy "in progress" naming if you use it anywhere
    const inProgress = tokens.filter(t => ["in progress", "in-progress", "inprogress"].includes(norm(t.status))).length;
    const highPriority = tokens.filter(t => norm(t.priority) === "high").length;

    const stats = document.querySelectorAll(".grid > div .text-3xl");
    if (stats.length >= 4) {
        stats[0].textContent = total;
        stats[1].textContent = pending;
        // keep in-progress in the 3rd card if you show it there; otherwise show resolved
        // I'll show in-progress (existing layout used that slot)
        stats[2].textContent = inProgress;
        stats[3].textContent = highPriority;
    }
}

// ✅ Filtering logic
function applyFilters() {
    const statusFilter = norm(document.getElementById("statusFilter").value);
    const priorityFilter = norm(document.getElementById("priorityFilter").value);
    const categoryFilter = norm(document.getElementById("categoryFilter").value);
    const search = (document.getElementById("searchInput").value || "").toLowerCase().trim();

    filteredTokens = allTokens.filter(token => {
        const tokenStatus = norm(token.status);
        const tokenPriority = norm(token.priority);
        const tokenCategory = norm(token.category);
        const tokenStudent = (token.studentId || "").toString().toLowerCase();
        const tokenTokenId = (token.tokenId || "").toString().toLowerCase();
        const tokenTitle = (token.title || "").toString().toLowerCase();

        const matchStatus = statusFilter === "all" || tokenStatus === statusFilter;
        const matchPriority = priorityFilter === "all" || tokenPriority === priorityFilter;
        const matchCategory = categoryFilter === "all" || tokenCategory === categoryFilter;

        const matchSearch =
            search === "" ||
            tokenStudent.includes(search) ||
            tokenTokenId.includes(search) ||
            tokenTitle.includes(search);

        return matchStatus && matchPriority && matchCategory && matchSearch;
    });

    populateTokensTable(filteredTokens);
}

// ✅ Event listeners for filters and search
document.getElementById("statusFilter").addEventListener("change", applyFilters);
document.getElementById("priorityFilter").addEventListener("change", applyFilters);
document.getElementById("categoryFilter").addEventListener("change", applyFilters);
document.getElementById("searchInput").addEventListener("input", applyFilters);

// ✅ Modal logic
function openTokenModal(id) {
    const token = allTokens.find(t => t.id === id);
    if (!token) return;

    const modal = document.getElementById("tokenModal");
    modal.classList.remove("hidden");

    document.getElementById("modalTitle").innerText = token.title;
    document.getElementById("modalDescription").innerText = token.description;
    document.getElementById("modalStudent").innerText = token.studentId;
    document.getElementById("modalStatus").innerText = token.status;
    document.getElementById("modalPriority").innerText = token.priority;
    document.getElementById("modalReply").value = token.tprReply || "";
    document.getElementById("modalTokenId").value = token.id;

    if (norm(token.status) === "resolved") {
        document.getElementById("replySection").classList.add("hidden");
    } else {
        document.getElementById("replySection").classList.remove("hidden");
    }
}

function closeModal() {
    document.getElementById("tokenModal").classList.add("hidden");
}

// ✅ Reply & resolve
// ✅ Reply & resolve with double-click protection
async function submitReply() {
  const replyBtn = document.querySelector("#replySection button");
  const id = document.getElementById("modalTokenId").value;
  const reply = document.getElementById("modalReply").value.trim();

  if (!reply) {
    alert("Please enter a reply before submitting.");
    return;
  }

  // ✅ Disable button immediately
  replyBtn.disabled = true;
  const originalText = replyBtn.innerText;
  replyBtn.innerText = "Sending...";

  try {
    const response = await fetch(`/api/tokens/${id}/reply`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ reply })
    });

    if (!response.ok) throw new Error("Failed to submit reply.");

    closeModal();
    await fetchTokens();
    showSuccess("Reply added and token marked as resolved.");
  } catch (err) {
    console.error("Error:", err);
    alert("❌ Failed to submit reply. Please try again.");
  } finally {
    // ✅ Re-enable safely
    replyBtn.disabled = false;
    replyBtn.innerText = originalText;
  }
}


// ✅ Styling helpers (matching your actual values)
function getStatusClass(status) {
    switch (norm(status)) {
        case "pending": return "bg-yellow-100 text-yellow-800";
        case "resolved": return "bg-green-100 text-green-800";
        case "in progress": return "bg-blue-100 text-blue-800";
        default: return "bg-gray-100 text-gray-700";
    }
}

function getPriorityClass(priority) {
    switch (norm(priority)) {
        case "high": return "bg-red-100 text-red-800";
        case "normal": return "bg-yellow-100 text-yellow-800"; // normal
        case "low": return "bg-green-100 text-green-800";
        default: return "bg-gray-100 text-gray-700";
    }
}

// ✅ Success banner
function showSuccess(msg) {
    const banner = document.createElement("div");
    banner.className = "fixed top-5 right-5 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg";
    banner.textContent = msg;
    document.body.appendChild(banner);
    setTimeout(() => banner.remove(), 2500);
}

// ✅ Manual refresh
function refreshTokens() {
    fetchTokens();
}

// ✅ Init
document.addEventListener("DOMContentLoaded", fetchTokens);
</script>


<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9812ca69301bdc7f',t:'MTc1ODIxODkyNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
